nii_file = '/Fridge/users/giovanni/projects/margriet/analysis/preproc_wouter/nipype/preproc_visual05_3TMB_prf/warpapply/output_visual05_3TMB_prf.nii';

n_volumes = [250, 250];

hdr = niftiinfo(nii_file);                        % read nifti header
TR = hdr.PixelDimensions(4);                      % 850 ms
images = {};
images{1} = read_bair_stimuli(n_volumes, TR);

disp('Loading fMRI')
nii = {};
nii{1} = niftiread(nii_file);
x = {};
x{1} = squeeze(nii{1}(69, 43, 12, :))';

x = [758.52264 784.5972 740.7278 720.98584 760.1906 709.44135 769.3403 694.8644 690.85956 750.7975 672.6574 792.48413 721.3439 756.65356 777.18585 703.1231 686.26013 689.0664 694.1888 703.8048 704.5991 730.76587 830.43036 751.991 826.3568 798.17834 800.0038 796.7637 740.27014 732.5657 760.5667 721.4709 735.47156 845.3838 837.12555 831.7511 850.47577 841.7675 865.8399 788.8848 796.90216 842.2631 793.31354 762.0121 852.9226 863.4406 775.9064 759.49304 794.0882 748.2386 724.0722 882.9607 806.95337 761.63934 784.8722 819.40967 796.31354 824.6357 803.4214 793.7285 773.45044 759.1333 716.318 779.7377 766.4833 720.3748 729.7475 715.7695 694.7543 690.9033 714.31506 631.13666 691.1397 682.52057 724.871 761.41956 715.99664 735.9402 799.4834 811.5436 752.57574 749.3838 765.80035 757.74365 734.54614 774.80945 761.8364 736.48926 753.92474 722.75134 752.1745 799.3798 787.18976 759.39685 749.3386 803.9036 805.959 775.0942 718.3615 679.32825 708.6224 722.0138 715.2587 717.49054 713.847 717.7827 704.0894 710.9498 797.91235 718.9667 737.51605 734.4639 791.9437 748.7365 748.91925 772.6688 760.1373 710.5375 755.0053 731.7831 748.2254 710.46655 725.36224 735.0734 697.3268 670.7949 662.5408 726.576 663.23157 704.7484 684.38995 771.61426 821.2763 790.6351 756.6711 802.4852 769.4166 751.60187 774.222 789.8843 802.7264 807.7064 838.3108 862.8719 829.679 860.73096 845.30786 863.539 801.00867 763.0344 756.47906 737.7838 699.31104 741.9341 700.3394 716.3065 693.0055 666.906 710.6776 694.36896 714.65295 745.1584 742.11475 813.78815 738.5075 732.01044 717.5773 742.9633 728.47974 728.6948 757.79205 755.9976 753.8176 738.5569 740.65344 735.0104 690.6589 688.205 700.1186 739.28827 717.9776 705.40735 755.3667 730.32416 715.93115 674.1093 732.8008 759.64325 770.32837 792.36224 811.9847 825.0433 803.94836 768.24835 808.50214 733.1456 773.2189 814.80676 743.28534 739.1581 793.0556 856.64325 867.19244 847.5319 818.1164 859.72754 806.05414 761.31055 714.45996 789.4639 795.725 729.7502 749.30743 842.19684 782.2576 730.7584 745.88684 819.9848 794.3263 780.25397 725.42816 758.9545 764.9338 757.31995 732.33624 811.4939 804.6878 773.0843 766.86926 781.4535 774.77783 715.333 679.9949 676.3579 700.5068 702.78864 637.5653 694.0305 664.107 689.8697 782.60986 711.7079 706.02246 737.61426 712.9689 714.9198 693.6051 699.9853 731.14276 655.85425 806.1976 742.4989 805.9715 814.38654 863.7823 799.5588 793.30475 787.99554 788.4096 730.0254 689.3254 761.55646 670.5448 707.0112 667.2089 721.42444 694.2341 652.56195 713.3864 712.7306 724.2356 698.6258 726.2549 728.45294 756.9344 848.71735 803.44904 802.1832 815.0523 760.1423 761.254 739.42126 753.8101 749.8533 779.6985 851.49457 882.77795 919.38336 915.96594 895.20306 868.10034 915.7357 836.6916 773.9738 784.24927 810.9142 827.30566 839.9445 823.17346 809.98145 868.7059 864.2434 826.5705 766.34625 835.84924 836.4976 770.31757 790.8588 903.2632 832.7986 835.08026 756.2999 812.9105 778.9466 785.48505 791.3218 747.8835 752.25665 769.10034 744.35706 701.8902 767.1641 783.6992 792.6426 700.33234 722.7271 751.3775 716.5699 726.3363 760.9328 841.06036 765.1955 771.1017 806.7927 791.7054 754.17255 800.68134 752.02606 816.7429 765.891 716.97626 797.43604 859.27686 794.2073 875.82513 837.5994 865.2406 808.5481 850.9877 812.0944 809.29315 834.2019 840.5064 768.84143 801.68427 772.8492 770.25024 781.30524 851.31537 743.1499 758.3116 851.87756 795.4834 886.74817 883.7934 882.14594 889.9895 875.48596 822.2909 846.4991 834.8806 753.8483 751.3874 764.5114 730.6343 774.54004 781.7516 786.4661 770.4503 784.55206 767.67346 824.07574 803.51215 778.56433 756.6491 796.05084 799.5299 776.4951 833.67004 811.1307 797.23596 869.78973 823.1824 876.361 895.104 851.5882 862.3463 847.84467 875.4677 831.67773 826.9563 795.14825 810.82623 737.5948 743.2251 754.61884 800.2507 839.7847 839.6062 816.87463 763.39777 770.0538 788.7122 759.2997 800.62036 742.8357 771.64526 832.95544 748.07117 792.89087 811.09753 819.8631 907.469 893.9754 805.89075 811.44635 862.83594 856.8128 789.9169 797.7245 808.6206 790.3787 764.73413 804.4419 785.09045 701.2977 733.70514 769.30426 796.5063 796.1011 825.6813 828.9947 817.5877 826.17114 818.5305 819.80176 808.08545 763.34937 828.286 875.18164 982.5568 898.0766 965.56995 794.46155 851.0097 875.9589 889.3381 894.3547 868.9325 939.6809 807.4286 797.8143 820.9767 862.5323 872.4461 869.3057 928.7826 949.2635 964.39514 894.3087 872.0787 799.5094 775.00006 762.4348 871.78687 845.1864 888.39667 883.10254 888.47125 945.1183 885.0938 794.9271 798.6535 765.43304 740.5207 730.85986 764.929 715.41327 781.86755 748.5321 688.4232 747.7625 766.51385 753.51447 777.9879 718.1877 752.0532 757.34576 698.08093 715.2805];

results = analyzePRF(images, {x}, TR, struct('seedmode', -2,'display','off'));

results


%%
TR = 0.85;
PATH_TO_APERTURES = '/Fridge/users/margriet/stimuli/BAIR_pRF/bar_apertures.mat';
BASELINE = 11.9;     % seconds
RESOLUTION = 100;

apertures = load(PATH_TO_APERTURES);
images = uint8(apertures.bar_apertures);

temp = zeros(RESOLUTION, RESOLUTION, size(images,3));
for p=1:size(images,3)
    temp(:,:,p) = imresize(images(:,:,p), [RESOLUTION RESOLUTION], 'cubic');
end
images = temp;

% Ensure that all images are binary
images_bin = zeros(size(images));
images_bin(images > .5) = 1;
images = images_bin;

% Add baseline
BASELINE_TR = round(BASELINE / TR);
stimulus_baseline = zeros(RESOLUTION, RESOLUTION, BASELINE_TR);

images = cat(3, stimulus_baseline, images, stimulus_baseline);

save('/Fridge/users/giovanni/projects/prf_mrvista/mcc/data/images.mat', 'images')
